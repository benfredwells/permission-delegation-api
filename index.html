<!DOCTYPE html>
<head>
<meta charset="UTF-8"/>
<meta name=viewport content="width=device-width, initial-scale=1"/>
<title>Permission Delegation API</title>

<script src='https://www.w3.org/Tools/respec/respec-w3c-common'
class='remove'></script>

<script class='remove'>
// (this is to make tidy happy)
var respecConfig = {
  specStatus:           "ED",
  shortName:            "permission-delegation",
  //publishDate:          "2016-02-17",
  //previousPublishDate:  "2016-02-17",
  //previousMaturity:     "WD",
  edDraftURI: "https://github.com/noncombatant/permission-delegation-api",
  // if this is a LCWD, uncomment and set the end of its review period
  // lcEnd: "20015-08-05",
  noIDLIn:       true,
  noLegacyStyle: true,
  editors: [
    {
      name: "Raymes Khoury",
      company: "Google Inc.",
      companyURL: "https://google.com/",
      w3cid: 45389
    },
    {
      name: "Chris Palmer",
      company: "Google Inc.",
      companyURL: "https://google.com/",
      w3cid: 45389
    }
  ],
  otherLinks: [{
    key: 'Participate',
    data: [{
              value: 'We are on Github.',
              href: 'https://github.com/noncombatant/permission-delegation-api'
          }, {
              value: 'File a bug.',
              href: 'https://github.com/noncombatant/permission-delegation-api/issues'
          }, {
              value: 'Commit history.',
              href: 'https://github.com/noncombatant/permission-delegation-api/commits/gh-pages'
          }, {
              value: 'Mailing list.',
              href: 'http://lists.w3.org/Archives/Public/public-webappsec/'
          }]
  },{
    key: 'Implementation status',
    data: [{
        value: "Blink/Chromium",
        href: "http://crbug.com/new"
    }, {
        value: "Gecko",
        href: "TODO"
    }]
  }],
  wg:           "Web Application Security Working Group",
  wgURI:        "http://www.w3.org/2011/webappsec/",
  wgPublicList: "public-webappsec",
  wgPatentURI:  "http://www.w3.org/2004/01/pp-impl/49309/status",
};
</script>

</head>

<body>

<section id='abstract'>

The <cite>Permission Delegation API</cite> allows a web application (the
<dfn>embedder</dfn>) to explicitly delegate and un-delegate permissions that it
holds to cross-origin embedded applications (known as <dfn>embedees</dfn>). It
also allows embedders to query the status of delegation to an embedee.

</section>

<section id='sotd'></section>

<section id='conformance'>

<p>This specification defines conformance criteria that apply to a single
product: the <dfn>user agent</dfn> that implements the interfaces that it
contains.</p>

<p>Implementations that use ECMAScript to expose the APIs defined in this
specification MUST implement them in a manner consistent with the ECMAScript
Bindings defined in the Web IDL specification [[!WEBIDL]].</p>

</section>

<section>

<h2>Dependencies</h2>

<p>The following concepts and interfaces are defined in [[!HTML]]:</p>

<ul>

<li><a
href='https://html.spec.whatwg.org/multipage/browsers.html#origin-2'><dfn>origin</dfn></a>
of a <a
href='https://html.spec.whatwg.org/multipage/dom.html#document'><dfn>Document</dfn></a>
and a <a
href='https://html.spec.whatwg.org/multipage/workers.html#workers'><dfn>worker</dfn></a>.</li>

<li><dfn><a
href="https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task">queue
a task</a></dfn></li>

<li><dfn><a
href="https://html.spec.whatwg.org/multipage/webappapis.html#fire-a-simple-event">fire
a simple event</a></dfn></li>

<li><dfn><a
href="https://html.spec.whatwg.org/multipage/webappapis.html#event-handlers">event
handler</a></dfn></li>

<li><dfn><a
href="https://html.spec.whatwg.org/multipage/webappapis.html#event-handler-event-type">event
handler event type</a></dfn></li>

<li><dfn><a
href='https://html.spec.whatwg.org/multipage/browsers.html#window'>Window</a></dfn></li>

<li><dfn><a
href='https://html.spec.whatwg.org/multipage/webappapis.html#global-object'>global
object</a></dfn></li>

<li><dfn><a href='https://html.spec.whatwg.org/multipage/embedded-content.html#the-iframe-element'>iframe
element</a></dfn></li>

</ul>

<p><a
href='http://people.mozilla.org/~jorendorff/es6-draft.html#sec-promise-objects'>
<dfn>Promise</dfn> objects</a> are defined in [[!ECMASCRIPT]].</p>

</section>

<section class='informative'>

<h2>Scope Of This Document</h2>

<p>The goal of this document is to specify an API which allows developers to
explicitly delegate permissions to embedded applications. Delegation (in the
context of this document) is the ability for an origin running in one frame to
share a permission grant with an embedded, cross-origin frame. Delegation of
permissions is already possible on the web platform. For example, if an origin
in a frame has been granted access to use geolocation, it can expose access to
the feature to other, cross-origin frames by communicating via postMessage. The
API described in this document provides a standard way of doing this which would
also be easier for web developers to implement.</p>

<p>Why is delegation useful? Delegation allows an application to share a
permission grant with a third-party without burdening the user with a need to
give consent. This is particularly useful when the user is not in a good
position to make a decision, for example they may not have the the required
understanding to make an informed decision. More concretely, there is evidence
that users don't have a good understanding of permission requests originating
from iframes. The embedded nature of iframes, along with the lack of browser UI
associated with them means that users can be confused about which origins they
are giving access to. This means that they are likely to make poor decisions
about permission access. In these cases a trusted embedding application may be
in a better position to decide for the user.</p>

<p>Note that there is an implicit trade-off in delegation. Although the user is
not burdened with the decision, it also means that control is taken out of their
hands and so discernment is required when deciding whether delegation is
appropriate. It is explicitly out of the scope of this document to define under
what circumstances delegation should be used, instead it just aims to formalize
an API for delegation. </p>

<p>There are several additional operations that are useful in conjunction with
delegating access which are also within scope of this document:
  <ul>
    <li>Revoking delegated access from an embedee.</li>
    <li>Querying the status of delegation to an embedee.</li>
  </ul>
</p>

<p>Allowing permission requests made by embedded frame to intercepted by an
embedder has also been proposed. This would allows access to be mediated in more
flexible ways. However, given the complexity of implementing such an API, it has
been left out of this document for the time being.</p>

</section>

<section>

<h2>Definitions</h2>

TODO: define embedder, embedee, delegate, undelegate?

</section>

<section>

<h2>Delegating Permissions</h2>

<p>There are 2 ways for an embedder to delegate permission grants to an embedee:
A declarative syntax in the HTML tag that instantiates the embedee; and an
imperative syntax that extends the Permissions API. These are described
below.</p>

<p>Once a permission has been delegated to an embedee, the embedee must have
access to use the permission as long as the following requirements are met:
  <ol>
    <li>The embedder and embedee meet the minimum security requirements to ask
    for the permission in the first place. Currently this requires that both
    embedder and embedee be running in
    <a href="http://www.w3.org/TR/powerful-features/">secure contexts</a>.</li>
    <li>The embedder itself has access to the permission.</li>
  </ol>
</p>

<p>The lifetime of the embedees access to the permission must be tied to the
lifetime of the embedders access to the permission. That is, the embedee will
only get access to the permission when the embedder has access and will lose
access if the embedder loses access.</p>

<p>Note that an embedder must still be able to ask for a permission to be
delegated even before it has access to use the permission itself. In cases like
this, a request to use the permission by the embedee may trigger an automatic
request to use the permission by the embedder. This allows embedees to get
access to permissions without embedders having to get access up front.</p>

<p>If an embedee performs a cross-origin navigation the permission must be
implicitly un-delegated and the embedee will lose access. This prevents
unintentionally delegating access to other origins.</p>

<section>

<h3>Delegation via the Declarative API</h3>

The permissions attribute is defined on the <a>iframe element<a>.

<pre class='idl'>
interface HTMLIFrameElement : HTMLElement {
  [PutForwards=value] readonly attribute DOMSettableTokenList permission;
};
</pre>

<p>The permissions attribute, when specified, will delegate the given set of
permissions to the embedee running in the iframe. Its value must be an unordered
set of unique space-separated tokens that are ASCII case-insensitive. The
allowed values are the permission names that come from the <a
href="https://w3c.github.io/permissions/#permission-registry">PermissionName</a>
enum in the Permissions API.</p>

</section>

<section>

<h3>Delegation via the Imperative API</h3>

The Permissions API is extended to provide functions for delegating and
undelegating permissions as well as querying the delegation status.

<pre class='idl'>
  [Exposed=(Window,Worker)]
  interface Permissions {
    Promise delegate((PermissionDescriptor or sequence&lt;PermissionDescriptor&gt;) permission);
    Promise undelegate((PermissionDescriptor or sequence&lt;PermissionDescriptor&gt;) permission);
    Promise&lt;boolean&gt; isDelegated(PermissionDescriptor permission);
  };
</pre>

PermissionDescriptor is defined in the Permission API. When called with these
functions it must contain a field which specifies the embedee:

<dl class='idl' title='dictionary PermissionDescriptor'>
  <dt>
    required PermissionName <a>name</a>
  </dt>
  <dt>
    HTMLIframeElement embedee
  </dt>
</dl>

<p>The embedee must be nested in the caller's browsing context.</p>

<p>Calling delegate will cause the given permissions to be delegated to their
embedees. The promise returned will resolve if the permission is successfully
delegated, otherwise it will be rejected. Similarly, undelegate will cause the
given permissions to no longer be delegated to their embedees.</p>

<p>The isDelegated function returns a promise which will resolve to true if the
permission is delegated to the given frame or to false otherwise.</p>

</section>

</section>

<section>

<h2>Examples</h2>

<p>Consider an embedder https://restaurant.example.net whose developers want to
show a map on the page that enables people to get directions to the restaurant.
They can do so by instantiating an iframe to the maps service
https://maps.example.com, and by explicitly delegating the
<var>geolocation</var> permission:

<pre class='example highlight'>
&lt;iframe id="embedee" src="https://maps.example.com/" permissions="geolocation"&gt;&lt;/iframe&gt;
</pre>

<p>Consider next that the developers of https://restaurant.example.net learn of
a new feature that https://maps.example.com provides, which is to send people
notifications when it’s time to leave to get to their destination on time.
(For example, people may want to know not just the directions to the restaurant,
but also to be notified when they should leave to make it by the time their
reservation starts.) The developers would explicitly grant the embedded iframe a
second permission, <var>notifications</var>:</p>

<pre class='example highlight'>
&lt;iframe id="embedee" src="https://maps.example.com/" permissions="geolocation notifications"&gt;&lt;/iframe&gt;
</pre>

Delegation via the imperative API:

<pre class='example highlight'>
var iframe = document.getElementById('embedee');
navigator.permissions.delegate({embedee: iframe, name: 'geolocation'}).then(
  function() {
    // Delegated geolocation
  }).catch(function() {
    // Did not delegate geolocation
  });
</pre>

Undelegating permissions:

<pre class='example highlight'>
var iframe = document.getElementById('embedee');
navigator.permissions.undelegate({embedee: iframe, name: 'geolocation'});
</pre>

Checking whether permission is delegated:

<pre class='example highlight'>
var iframe = document.getElementById('embedee');
navigator.permissions.isDelegated({embedee: iframe, name: 'geolocation'})
  .then(function(result) {
    // result === true
  });
</pre>

</section>

<section>

<h2>Security Considerations</h2>

TODO: What security considerations need discussion here? This proposal in itself
does not enable anything that was not already possible on the platform.

</section>

<section>

<h2>Acknowledgements</h2>

TODO
</section>

</body>
